<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Artificial -and- Talentless - Settings</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Special Elite for that vintage typewriter feel -->
    <link href="https://fonts.googleapis.com/css2?family=Special+Elite&display=swap" rel="stylesheet">
    <style>
        /* Custom body styles using your specified background and font */
        body {
            font-family: 'Special Elite', monospace;
            background-color: #F7F7D3; /* Light cream background */
            color: #000000; /* Default text color */
            min-height: 100vh; /* Ensure body takes full viewport height */
            margin: 0;
            /* Adjust padding-top and padding-bottom to create space for fixed logo and button footer */
            padding-top: 120px; /* Space for fixed logo + buffer */
            padding-bottom: 70px; /* Adjusted: Reduced space for fixed button footer + buffer */
            padding-left: 20px;
            padding-right: 20px;
            box-sizing: border-box;
            display: flex; /* Enable flexbox for vertical layout */
            flex-direction: column; /* Stack children vertically */
            align-items: center; /* Center horizontally */
            overflow-x: hidden; /* Prevent horizontal scrolling */
            position: relative; /* Context for fixed positioning */
        }
        /* Dark mode styles, adopting your specified colors */
        body.dark-mode {
            background-color: #000000;
            color: #F7F7D3;
        }

        /* Container for the logo, fixed at the top of the viewport */
        #logo-container {
            position: fixed; /* Fixes the logo relative to the viewport */
            top: 20px; /* Distance from the top of the viewport */
            left: 50%; /* Start from the middle */
            transform: translateX(-50%); /* Pull back by half its width to truly center */
            z-index: 10; /* Ensures it stays above other content */
            width: 100%; /* Allows max-width on the logo itself to work properly */
            text-align: center; /* Center the image within its fixed container */
        }

        /* Styling for the main logo image within its fixed container */
        #logo {
            max-width: 200px; /* Your specified max-width */
            height: auto; /* Maintain aspect ratio */
            display: block; /* Remove extra space below image */
            margin: 0 auto; /* Center the image within its container */
        }

        /* Adjust logo size and body padding for larger screens */
        @media (min-width: 600px) {
            #logo {
                max-width: 200px; /* Your specified smaller size for larger screens */
            }
            body {
                padding-top: 100px; /* Adjusted padding-top for smaller logo */
            }
        }

        /* Main content area for settings, dynamically centered */
        #main-content-area {
            flex-grow: 1; /* Allows this container to take up all available vertical space */
            display: flex; /* Enable flexbox for its children */
            flex-direction: column; /* Stack children vertically */
            justify-content: center; /* Centers the content vertically */
            align-items: center; /* Center content horizontally */
            width: 100%;
            max-width: 500px; /* Max width for the settings containers */
            padding: 0 1rem; /* Padding for inner content on very small screens */
            box-sizing: border-box; /* Include padding in element's total width */
            margin-top: 20px; /* Pushes content area down slightly */
        }

        /* General setting section styling */
        .setting-section {
            width: 100%;
            margin-bottom: 25px;
            padding: 15px;
            border: 1px solid #000000;
            border-radius: 8px;
            background-color: #F7F7D3;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        body.dark-mode .setting-section {
            background-color: #1A1A1A;
            border-color: #F7F7D3;
        }

        .setting-title {
            font-family: 'Special Elite', monospace;
            font-size: 1.3em;
            color: #000000;
            margin-bottom: 15px;
            text-align: center;
            line-height: 1.4;
        }
        body.dark-mode .setting-title {
            color: #F7F7D3;
        }

        /* Input field styling */
        .input-field {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #000000;
            border-radius: 5px;
            font-family: 'Special Elite', monospace;
            font-size: 1em;
            background-color: #F7F7D3;
            color: #000000;
            box-sizing: border-box;
        }
        .input-field:focus {
            outline: none;
            border-color: #000000;
        }
        body.dark-mode .input-field {
            background-color: #333;
            color: #F7F7D3;
            border-color: #F7F7D3;
        }

        /* Dropdown select styling */
        select {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #000000;
            border-radius: 5px;
            font-family: 'Special Elite', monospace;
            font-size: 1em;
            background-color: #F7F7D3;
            color: #000000;
            box-sizing: border-box;
            -webkit-appearance: none; /* Remove default arrow */
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20256%20512%22%3E%3Cpath%20fill%3D%22%230A0518%22%20d%3D%22M192%20424.4l-96-96%2096-96%2022.6%2022.6-67.4%2067.4%2067.4%2067.4z%22%2F%3E%3C%2Fsvg%3E'); /* Custom arrow */
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 12px;
        }
        select:focus {
            outline: none;
            border-color: #000000;
        }
        body.dark-mode select {
            background-color: #333;
            color: #F7F7D3;
            border-color: #F7F7D3;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20256%20512%22%3E%3Cpath%20fill%3D%22%23F7F7D3%22%20d%3D%22M192%20424.4l-96-96%2096-96%2022.6%2022.6-67.4%2067.4%2067.4%2067.4z%22%2F%3E%3C%2Fsvg%3E'); /* Dark mode custom arrow */
        }

        /* Checkbox styling */
        .checkbox-container {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            justify-content: center;
        }
        .checkbox-container input[type="checkbox"] {
            margin-right: 10px;
            width: 18px;
            height: 18px;
            accent-color: #000000; /* Custom color for checkbox */
        }
        body.dark-mode .checkbox-container input[type="checkbox"] {
            accent-color: #F7F7D3;
        }
        .checkbox-container label {
            font-family: 'Special Elite', monospace;
            font-size: 0.95em;
            color: #000000;
        }
        body.dark-mode .checkbox-container label {
            color: #F7F7D3;
        }

        /* Link styling */
        .api-link {
            font-family: 'Special Elite', monospace;
            font-size: 0.9em;
            color: #000000;
            text-decoration: underline;
            margin-top: 5px;
            display: block;
            text-align: center;
        }
        body.dark-mode .api-link {
            color: #F7F7D3;
        }

        /* Loading spinner styles */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #000000;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            margin: 10px auto; /* Center it */
            display: none; /* Hidden by default */
        }
        body.dark-mode .spinner {
            border-color: rgba(247, 247, 211, 0.2);
            border-left-color: #F7F7D3;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Footer for the global navigation buttons, fixed at the bottom */
        #button-footer {
            position: fixed; /* Fixes the footer relative to the viewport */
            bottom: 20px; /* Distance from the bottom of the viewport */
            left: 50%; /* Start from the middle */
            transform: translateX(-50%); /* Pull back by half its width to truly center */
            z-index: 10; /* Ensure it stays above other content */
            width: calc(100% - 40px); /* Full width minus body padding */
            max-width: 300px; /* Max width to match previous button size */
            display: flex; /* Use flexbox for buttons */
            justify-content: space-between; /* Space them out */
            gap: 10px; /* Gap between buttons */
            padding: 0; /* No vertical padding */
            box-sizing: border-box;
        }

        /* Styling for navigation buttons, matching previous screens */
        .nav-button {
            background-color: #000000;
            color: #F7F7D3;
            border: none;
            padding: 10px 20px;
            font-size: 1.1em;
            font-family: 'Special Elite', monospace;
            cursor: pointer;
            border-radius: 10px;
            flex-grow: 1;
            transition: opacity 0.2s ease, background-color 0.2s ease, color 0.2s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .nav-button:hover:not(:disabled) {
            opacity: 0.9;
        }
        .nav-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        body.dark-mode .nav-button {
            background-color: #F7F7D3;
            color: #000000;
        }
        body.dark-mode .nav-button:disabled {
            background-color: #F7F7D3;
            color: #000000;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <!-- Container for the logo, fixed at the top of the viewport -->
    <div id="logo-container">
        <img id="logo" src="assets/logo.png" alt="Artificial -and- Talentless Logo" onerror="this.onerror=null; this.src='https://placehold.co/350x80/1A1A1A/F7F7D3?text=Logo'" data-dark-src="assets/logo-dark.png">
    </div>

    <!-- Main content area for displaying settings, centered vertically -->
    <div id="main-content-area">
        <!-- API Key and Model Section -->
        <div class="setting-section">
            <h2 class="setting-title">AI Engine Settings</h2>
            <label for="openrouter-api-key" class="block text-sm mb-2 text-center">OpenRouter API Key:</label>
            <input type="password" id="openrouter-api-key" class="input-field" placeholder="sk-...">
            <a href="https://openrouter.ai/keys" target="_blank" class="api-link">Get your API key here</a>

            <label for="openrouter-model-select" class="block text-sm my-2 text-center">Select Model:</label>
            <select id="openrouter-model-select" class="input-field">
                <option value="">Loading models...</option>
            </select>
            <div id="model-loading-spinner" class="spinner"></div>

            <div class="checkbox-container">
                <input type="checkbox" id="filter-free-models">
                <label for="filter-free-models">Show only free models</label>
            </div>
        </div>

        <!-- Content Type Section -->
        <div class="setting-section">
            <h2 class="setting-title">Content Type</h2>
            <select id="content-type-select" class="input-field">
                <option value="Mild Insults">Mild Insults</option>
                <option value="Harsh Insults">Harsh Insults</option>
                <option value="Cruel Insults">Cruel Insults</option>
                <option value="Sarcastic Affirmations">Sarcastic Affirmations</option>
                <option value="Dad Jokes">Dad Jokes</option>
                <option value="Affirmations">Affirmations</option>
                <option value="Inspirational Quotes">Inspirational Quotes</option>
                <option value="Random">Random</option>
                <option value="Backhanded Compliments">Backhanded Compliments</option>
            </select>
        </div>
    </div>

    <!-- Global Footer for Navigation Buttons, fixed at the bottom -->
    <div id="button-footer">
        <button id="prev-button" class="nav-button">Prev</button>
        <button id="next-button" class="nav-button">Finish</button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
        // 🔁 data-dark-src swap logic
        document.querySelectorAll("img[data-dark-src]").forEach(img => {
          if (document.body.classList.contains("dark-mode")) {
            img.src = img.dataset.darkSrc;
          }
        });
            // Apply theme based on localStorage
            const theme = localStorage.getItem('theme');
            if (theme === 'dark') {
                document.body.classList.add('dark-mode');
            }

            const openrouterApiKeyInput = document.getElementById('openrouter-api-key');
            const openrouterModelSelect = document.getElementById('openrouter-model-select');
            const filterFreeModelsCheckbox = document.getElementById('filter-free-models');
            const modelLoadingSpinner = document.getElementById('model-loading-spinner');
            const contentTypeSelect = document.getElementById('content-type-select');

            const prevButton = document.getElementById('prev-button');
            const nextButton = document.getElementById('next-button');

            let allOpenRouterModels = []; // To store all fetched models

            // --- API Call to OpenRouter Models ---
            async function fetchOpenRouterModels() {
                modelLoadingSpinner.style.display = 'block'; // Show spinner
                openrouterModelSelect.innerHTML = '<option value="">Loading models...</option>'; // Show loading text
                openrouterModelSelect.disabled = true; // Disable select during load

                try {
                    const response = await fetch('https://openrouter.ai/api/v1/models', {
                        headers: {
                            'Authorization': `Bearer ${openrouterApiKeyInput.value.trim()}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`Failed to fetch models: ${response.status} - ${errorData.message || response.statusText}`);
                    }

                    const data = await response.json();
                    // Filter and map models from OpenRouter API response
                    allOpenRouterModels = data.data.map(model => ({
                        id: model.id,
                        name: model.name,
                        // OpenRouter provides 'pricing' object; check if it has a 'free' property or equivalent
                        free: model.pricing && model.pricing.prompt && model.pricing.prompt === 0 && model.pricing.completion && model.pricing.completion === 0
                    }));

                } catch (error) {
                    console.error("Error fetching OpenRouter models:", error);
                    // Display an error message to the user
                    displayMessage(`Failed to load models: ${error.message}. Check your API Key or network.`, "error");
                    openrouterModelSelect.innerHTML = '<option value="">Error loading models</option>';
                    allOpenRouterModels = []; // Clear models on error
                } finally {
                    modelLoadingSpinner.style.display = 'none'; // Hide spinner
                    openrouterModelSelect.disabled = false; // Enable select
                    populateModelDropdown(); // Populate dropdown with fetched (or error) models
                }
            }

            // --- Populate Model Dropdown ---
            function populateModelDropdown() {
                openrouterModelSelect.innerHTML = ''; // Clear previous options
                let modelsToDisplay = allOpenRouterModels;

                if (filterFreeModelsCheckbox.checked) {
                    modelsToDisplay = allOpenRouterModels.filter(model => model.free);
                }

                if (modelsToDisplay.length === 0) {
                    openrouterModelSelect.innerHTML = '<option value="">No models found with current filter.</option>';
                    nextButton.disabled = true; // Disable next if no models available
                    return;
                }

                // Sort models alphabetically by name
                modelsToDisplay.sort((a, b) => a.name.localeCompare(b.name));

                modelsToDisplay.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.id;
                    option.textContent = model.name;
                    openrouterModelSelect.appendChild(option);
                });

                // Set previously selected model if available
                const storedSettings = JSON.parse(localStorage.getItem('appSettings')) || {};
                openrouterModelSelect.value = storedSettings.selectedModel || '';

                // Update next button state after populating
                updateNextButtonState();
            }

            // --- Update Next Button State (Validation) ---
            function updateNextButtonState() {
                const isApiKeyEntered = openrouterApiKeyInput.value.trim() !== '';
                const isModelSelected = openrouterModelSelect.value !== '';
                const isContentTypeSelected = contentTypeSelect.value !== '';

                nextButton.disabled = !(isApiKeyEntered && isModelSelected && isContentTypeSelected);
            }

            // --- Event Listeners ---
            openrouterApiKeyInput.addEventListener('input', () => {
                updateNextButtonState();
                // Re-fetch models if API key changes (optional, but useful)
                // Debounce this in a real app to prevent too many calls
                if (openrouterApiKeyInput.value.trim().length > 10) { // Simple heuristic
                    fetchOpenRouterModels();
                }
            });
            openrouterModelSelect.addEventListener('change', updateNextButtonState);
            contentTypeSelect.addEventListener('change', updateNextButtonState);
            filterFreeModelsCheckbox.addEventListener('change', () => {
                populateModelDropdown(); // Re-populate when filter changes
            });

            prevButton.addEventListener('click', () => {
                // Navigate back to the last onboarding question (improve)
                window.location.href = 'questions.html'; // Corrected navigation
            });

            nextButton.addEventListener('click', () => {
                // Save settings to localStorage
                const appSettings = {
                    apiKey: openrouterApiKeyInput.value.trim(),
                    selectedModel: openrouterModelSelect.value,
                    contentType: contentTypeSelect.value
                };
                localStorage.setItem('appSettings', JSON.stringify(appSettings));
                localStorage.setItem('isOnboarded', 'true'); // Mark onboarding as complete

                // Navigate to the main generator page
                window.location.href = 'generator.html';
            });

            // Custom message box function (reused from onboarding)
            function displayMessage(message, type = "info") {
                const messageBox = document.createElement('div');
                messageBox.classList.add('message-box', type);
                messageBox.textContent = message;
                document.body.appendChild(messageBox);

                messageBox.style.opacity = 0; // Start invisible for transition
                if (document.body.classList.contains('dark-mode')) {
                    messageBox.style.backgroundColor = '#F7F7D3';
                    messageBox.style.color = '#000000';
                }

                setTimeout(() => { messageBox.style.opacity = 1; }, 10);
                setTimeout(() => {
                    messageBox.style.opacity = 0;
                    messageBox.addEventListener('transitionend', () => messageBox.remove());
                }, 3000);
            }

            // --- Initial Load ---
            // Load existing settings if they exist
            const storedSettings = JSON.parse(localStorage.getItem('appSettings')) || {};
            if (storedSettings.apiKey) {
                openrouterApiKeyInput.value = storedSettings.apiKey;
            }
            if (storedSettings.selectedModel) {
                // Model will be set after fetchOpenRouterModels completes
            }
            if (storedSettings.contentType) {
                contentTypeSelect.value = storedSettings.contentType;
            }

            // Fetch models on page load if an API key is present
            // Or if the API key input is empty, don't auto-fetch, wait for user input
            if (openrouterApiKeyInput.value.trim() !== '') {
                fetchOpenRouterModels();
            } else {
                 openrouterModelSelect.innerHTML = '<option value="">Enter API Key to load models</option>';
                 openrouterModelSelect.disabled = true;
                 updateNextButtonState(); // Ensure button is disabled if API key is missing
            }
        });
    </script>
</body>
</html>

